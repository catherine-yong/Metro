#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/types.h>
#include <fcntl.h>
#include "lignes.h"

#define NB_LIGNES 100


void afficher_lignes(Une_ligne *head)
{
    while (head)
    {
        printf("\n code :%s", head->code);
        printf("\n vitesse : %.2f", head->vitesse);
        printf("\n intervalle : %.2f", head->intervalle);
        printf("\n couleur : %s \n\n", head->color);
        head = head -> suiv;
    }
}
//fonction pour ajouter une valeur au debut ;

Une_ligne *ajouter_debut(Une_ligne * head, char* code, char* color, float intervalle, float vitesse)
{
   // printf("fct ajouter debut : %s \n", code);
    Une_ligne * nouv = (Une_ligne *) malloc (sizeof(Une_ligne));
    nouv -> code = code;
    nouv -> color = color;
    nouv -> intervalle = intervalle;
    nouv -> vitesse = vitesse;
    nouv -> suiv = head; /*suiv pointe sur tete*/
    

    return (nouv);
}

//fonction pour ajouter une valeur à la fin ;

Une_ligne * ajouter_fin(Une_ligne* head, char* code, char* color, float intervalle, float vitesse)
{
    if (!head)
    {
        head = ajouter_debut(head, code, color, intervalle, vitesse);
        //printf("fct ajouter fin le IF : %s \n", code);
    }
    else
    {
        Une_ligne *nouv = (Une_ligne *) malloc (sizeof (Une_ligne));
        nouv -> code = code;
        nouv -> color = color;
        nouv -> intervalle = intervalle;
        nouv -> vitesse = vitesse;
        nouv -> suiv = NULL;/*car c'est le dernier il n'y a pas de suivant*/
        
        Une_ligne* temp = head;
        while (temp->suiv)
        {
            temp = temp->suiv;
        }
        temp->suiv = nouv;
        //printf("fct ajouter debut ELSE : %s \n", code);
    }
    return (head);
}

//fonction pour afficher la liste;


//fonction pour désallouer la mémoire;

void detruire_lignes(Une_ligne* head)
{
    Une_ligne* phead = head;
    while (phead)
    {
        head = phead;
        free(phead->code);
        free(phead->color);
        free(&(phead->intervalle));
        free(&(phead->vitesse));
        phead = phead -> suiv;
    }
}// pas encore tester

//fonction lire lignes;

Une_ligne* lire_ligne(char* nom_fichier)
{
    FILE* fichier ;
    char ligne[NB_LIGNES];
    char* ptr_chaine ;
    Une_ligne* head = NULL;

    
    // notre fichier lignes_metro.csv a 3 cellules : vitesse, intervalle et couleur

    char* code = NULL;
    code = (char*) malloc (sizeof (char));
    float vitesse = 0.0;
    float intervalle = 0.0;
    char* color = NULL;
    color = (char*) malloc (sizeof (char));

    //on ouvre le fichier csv

    fichier = fopen( "lignes_met.csv", "r") ;
    
    if (fichier == NULL)
    {
        printf("Ouverture du fichier impossible");
        exit(0);
    }

    // on lit le fichier ligne par ligne
    
    while (fgets( ligne, NB_LIGNES, fichier) != NULL)
    {
         
        // on appelle la fonction strtok et on initialise ptr_chaine

        ptr_chaine = strtok (ligne, ";");

        // code métro

        if (sscanf(ptr_chaine,"%s",code) != 1)
        {
            puts("\n Problème lors de la lecture");
            code[0] = 19;
        }
        ptr_chaine = strtok (NULL, ";");
        
        // vitesse

        if (sscanf(ptr_chaine,"%2f", &vitesse) != 1)
        {
            puts("\n Problème lors de la lecture");
            vitesse = -1.0;
        }
        ptr_chaine = strtok (NULL, ";");

        // intervalle
        
        if (sscanf(ptr_chaine,"%2f", &intervalle) != 1)
        {
            puts("\n Problème lors de la lecture");
            intervalle = -1.0;
        }
        ptr_chaine = strtok (NULL, ";");
        
        // couleur

        if (sscanf(ptr_chaine,"%s", color) != 1)
        {
            puts("\n Problème lors de la lecture");
            color[0] = 0;
        }
        ptr_chaine = strtok (NULL, ";");
        
        head = ajouter_fin(head,code,color,intervalle,vitesse);
        //printf("fct lire ligne WHILE : %s \n", code);
        afficher_lignes(head);
    }
    
    //fermeture du fichier
    fclose(fichier);
    //printf("fct lire ligne : %s \n", code);
    //printf("\nFICHIER \n");
    //afficher_lignes(head);
    return head;
}

//fonction pour chercher une ligne en fct de son code;

Une_ligne* chercher_ligne(Une_ligne* lligne,char* code1 )
{
    Une_ligne* head = lligne;
    printf("        AFFICHE   \n");
    afficher_lignes(lligne);
    // tant que la liste n'est pas finie
    while (head != NULL)
    {
        //printf("code = %s \n", head->code);
        //c = strcmp(head->code, code1);
        //printf("c = %d \n", c);
        if (strcmp(code1, head->code) == 0)
        {
            printf("\n\n    dans 3  \n");
            return head;
        }
        head = head->suiv;
    }
    return NULL;

}

int main(int argc, char **argv)
{
    
    Une_ligne* ligne;
    ligne = lire_ligne("../lignes_met.csv");
    
    //ligne = chercher_ligne(ligne, "M3");
    //printf("\n DANS LE MAIN \n");
    //afficher_lignes(ligne);
    
    
    return 0;
}

